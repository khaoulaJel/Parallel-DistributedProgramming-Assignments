#!/bin/bash

echo "=============================================="
echo "Matrix Multiplication OpenMP Benchmark"
echo "=============================================="
echo ""

# Compile programs
echo "Compiling programs..."
gcc -fopenmp -O3 -o matmul_collapse matmul_collapse.c -lm
gcc -fopenmp -O3 -o matmul_scheduling matmul_scheduling.c -lm

if [ $? -ne 0 ]; then
    echo "Compilation failed!"
    exit 1
fi

echo "Compilation successful!"
echo ""

# Thread counts
threads=(1 2 4 8 16)

# Number of runs for averaging
NUM_RUNS=3

# ==================================================
# PART 1: Basic Parallelization with collapse
# ==================================================
echo "PART 1: Testing basic parallelization with collapse directive"
echo "=============================================================="

output_file="matmul_basic_results.csv"
echo "Threads,Elapsed_Time,Speedup,Efficiency" > $output_file

# Function to get average time
get_average_time() {
    local program=$1
    local num_threads=$2
    local total_time=0
    
    for ((i=1; i<=NUM_RUNS; i++)); do
        result=$(./$program $num_threads | cut -d',' -f2)
        total_time=$(echo "$total_time + $result" | bc -l)
    done
    
    avg=$(echo "scale=6; $total_time / $NUM_RUNS" | bc -l)
    echo $avg
}

# Get baseline time
echo "Running serial version..."
serial_time=$(get_average_time "matmul_collapse" 1)
echo "Serial time: $serial_time seconds"
echo ""

# Test with different thread counts
for t in "${threads[@]}"
do
    echo "Testing with $t threads..."
    elapsed=$(get_average_time "matmul_collapse" $t)
    speedup=$(echo "scale=4; $serial_time / $elapsed" | bc -l)
    efficiency=$(echo "scale=2; ($speedup / $t) * 100" | bc -l)
    
    echo "  Time: $elapsed sec"
    echo "  Speedup: $speedup"
    echo "  Efficiency: $efficiency%"
    echo ""
    
    echo "$t,$elapsed,$speedup,$efficiency" >> $output_file
done

echo "Basic results saved to $output_file"
echo ""

# ==================================================
# PART 2: Scheduling Strategies
# ==================================================
echo "PART 2: Testing different scheduling strategies"
echo "================================================"

schedules=("static" "dynamic" "guided")
chunk_sizes=(0 10 50 100)

output_file2="matmul_scheduling_results.csv"
echo "Threads,Schedule,Chunk,Elapsed_Time" > $output_file2

# Test with 4 threads for scheduling comparison
test_threads=4
echo "Testing scheduling with $test_threads threads..."
echo ""

for sched in "${schedules[@]}"
do
    echo "Testing $sched scheduling..."
    for chunk in "${chunk_sizes[@]}"
    do
        if [ $chunk -eq 0 ]; then
            chunk_label="default"
        else
            chunk_label=$chunk
        fi
        
        total_time=0
        for ((i=1; i<=NUM_RUNS; i++)); do
            result=$(./matmul_scheduling $test_threads $sched $chunk | cut -d',' -f4)
            total_time=$(echo "$total_time + $result" | bc -l)
        done
        avg=$(echo "scale=6; $total_time / $NUM_RUNS" | bc -l)
        
        echo "  $sched (chunk=$chunk_label): $avg sec"
        echo "$test_threads,$sched,$chunk,$avg" >> $output_file2
    done
    echo ""
done

echo "Scheduling results saved to $output_file2"
echo ""

# ==================================================
# PART 3: Detailed Thread Scaling
# ==================================================
echo "PART 3: Detailed thread scaling analysis"
echo "========================================="

output_file3="matmul_detailed_results.csv"
echo "Threads,Schedule,Elapsed_Time,Speedup,Efficiency" > $output_file3

for sched in "${schedules[@]}"
do
    echo "Testing $sched scheduling across all thread counts..."
    
    # Get serial baseline for this schedule
    serial=$(get_average_time_sched $sched 1)
    
    for t in "${threads[@]}"
    do
        total_time=0
        for ((i=1; i<=NUM_RUNS; i++)); do
            result=$(./matmul_scheduling $t $sched 0 | cut -d',' -f4)
            total_time=$(echo "$total_time + $result" | bc -l)
        done
        elapsed=$(echo "scale=6; $total_time / $NUM_RUNS" | bc -l)
        
        speedup=$(echo "scale=4; $serial_time / $elapsed" | bc -l)
        efficiency=$(echo "scale=2; ($speedup / $t) * 100" | bc -l)
        
        echo "  $t threads: $elapsed sec (speedup: $speedup, efficiency: $efficiency%)"
        echo "$t,$sched,$elapsed,$speedup,$efficiency" >> $output_file3
    done
    echo ""
done

echo "Detailed results saved to $output_file3"
echo ""
echo "All benchmarks complete!"
